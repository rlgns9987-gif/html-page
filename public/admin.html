<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëª¨ë‘ì—ë“€ - ìƒë‹´ ê´€ë¦¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nanum Gothic', -apple-system, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: #1a1a1a;
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 1rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
        }

        .header-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .refresh-btn {
            background: #f4df11;
            color: #1a1a1a;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: #fff04d;
            transform: translateY(-2px);
        }

        .logout-btn {
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            font-size: 0.9rem;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* í•„í„° ì˜ì—­ */
        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .filter-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .filter-group select {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .filter-btn:hover {
            border-color: #1a1a1a;
        }

        .filter-btn.active {
            background: #1a1a1a;
            color: white;
            border-color: #1a1a1a;
        }

        /* í†µê³„ ì¹´ë“œ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.25rem;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .stat-card .number {
            font-size: 1.75rem;
            font-weight: 800;
        }

        .stat-card.total .number { color: #1a1a1a; }
        .stat-card.pending .number { color: #f59e0b; }
        .stat-card.paid .number { color: #10b981; }
        .stat-card.fail .number { color: #ef4444; }

        /* í…Œì´ë¸” */
        .table-wrapper {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .table-header h2 {
            font-size: 1.25rem;
        }

        .table-scroll {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        th, td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid #eee;
            white-space: nowrap;
        }

        th {
            background: #fafafa;
            font-weight: 700;
            font-size: 0.85rem;
            color: #666;
        }

        tr:hover {
            background: #fafafa;
        }

        .goals-cell {
            max-width: 200px;
            white-space: normal;
        }

        .goal-tag {
            display: inline-block;
            background: #e5e7eb;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            margin: 0.1rem;
        }

        .manager-badge {
            display: inline-block;
            padding: 0.35rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .manager-badge.seungmin {
            background: #dbeafe;
            color: #1e40af;
        }

        .manager-badge.gihun {
            background: #fce7f3;
            color: #be185d;
        }

        .status-select {
            padding: 0.4rem 0.75rem;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            cursor: pointer;
            min-width: 100px;
        }

        .status-select.pending {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .status-select.paid {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .status-select.fail {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .delete-btn {
            background: #fee2e2;
            color: #dc2626;
            border: none;
            padding: 0.4rem 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .delete-btn:hover {
            background: #dc2626;
            color: white;
        }

        .loading, .empty {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .date-cell {
            font-size: 0.85rem;
            color: #666;
        }

        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“‹ ìƒë‹´ ì‹ ì²­ ê´€ë¦¬</h1>
            <div class="header-buttons">
                <button class="refresh-btn" onclick="loadConsults()">ìƒˆë¡œê³ ì¹¨</button>
                <a href="/admin/logout" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
            </div>
        </header>

        <!-- í•„í„° ì˜ì—­ -->
        <div class="filters">
            <div class="filter-group">
                <label>ì›”ë³„</label>
                <select id="monthFilter" onchange="applyFilters()">
                    <option value="all">ì „ì²´</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ë‹´ë‹¹ì</label>
                <select id="managerFilter" onchange="applyFilters()">
                    <option value="all">ì „ì²´</option>
                    <option value="seungmin">ìŠ¹ë¯¼</option>
                    <option value="gihun">ê¸°í›ˆ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ìƒíƒœ</label>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-status="all">ì „ì²´</button>
                    <button class="filter-btn" data-status="pending">ëŒ€ê¸°ì¤‘</button>
                    <button class="filter-btn" data-status="success">ê²°ì œ</button>
                    <button class="filter-btn" data-status="fail">ì‹¤íŒ¨</button>
                </div>
            </div>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats">
            <div class="stat-card total">
                <h3>ì „ì²´</h3>
                <div class="number" id="totalCount">-</div>
            </div>
            <div class="stat-card pending">
                <h3>ëŒ€ê¸°ì¤‘</h3>
                <div class="number" id="pendingCount">-</div>
            </div>
            <div class="stat-card paid">
                <h3>ê²°ì œ</h3>
                <div class="number" id="paidCount">-</div>
            </div>
            <div class="stat-card fail">
                <h3>ì‹¤íŒ¨</h3>
                <div class="number" id="failCount">-</div>
            </div>
        </div>

        <!-- í…Œì´ë¸” -->
        <div class="table-wrapper">
            <div class="table-header">
                <h2>ìƒë‹´ ì‹ ì²­ ëª©ë¡</h2>
            </div>
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ë‹´ë‹¹ì</th>
                            <th>ì‹ ì²­ì¼ì‹œ</th>
                            <th>ì´ë¦„</th>
                            <th>ì—°ë½ì²˜</th>
                            <th>í•™ìŠµëª©í‘œ</th>
                            <th>ìµœì¢…í•™ë ¥</th>
                            <th>ìƒë‹´ë°©ì‹</th>
                            <th>ìƒíƒœ</th>
                            <th>ì‚­ì œ</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        <tr>
                            <td colspan="10" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let currentStatusFilter = 'all';
        let currentMonthFilter = 'all';
        let currentManagerFilter = 'all';

        document.addEventListener('DOMContentLoaded', function() {
            loadConsults();
            setupStatusFilterButtons();
            generateMonthOptions();
        });

        // ìƒíƒœ í•„í„° ë²„íŠ¼ ì„¤ì •
        function setupStatusFilterButtons() {
            const filterBtns = document.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentStatusFilter = this.dataset.status;
                    applyFilters();
                });
            });
        }

        // ì›”ë³„ ì˜µì…˜ ìƒì„± (ìµœê·¼ 12ê°œì›”)
        function generateMonthOptions() {
            const monthFilter = document.getElementById('monthFilter');
            const now = new Date();
            
            for (let i = 0; i < 12; i++) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const value = `${year}-${String(month).padStart(2, '0')}`;
                const label = `${year}ë…„ ${month}ì›”`;
                
                const option = document.createElement('option');
                option.value = value;
                option.textContent = label;
                monthFilter.appendChild(option);
            }
        }

        // ë‹´ë‹¹ì ê²°ì • (id í™€ìˆ˜: ìŠ¹ë¯¼, ì§ìˆ˜: ê¸°í›ˆ)
        function getManager(id) {
            return id % 2 === 1 ? 'seungmin' : 'gihun';
        }

        function getManagerName(id) {
            return id % 2 === 1 ? 'ìŠ¹ë¯¼' : 'ê¸°í›ˆ';
        }

        // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadConsults() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr><td colspan="10" class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';

            try {
                const response = await fetch('/api/consult');
                const result = await response.json();

                if (result.success) {
                    allData = result.data;
                    applyFilters();
                } else {
                    tableBody.innerHTML = '<tr><td colspan="10" class="empty">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</td></tr>';
                }
            } catch (error) {
                console.error('Error:', error);
                tableBody.innerHTML = '<tr><td colspan="10" class="empty">ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</td></tr>';
            }
        }

        // í•„í„° ì ìš©
        function applyFilters() {
            currentMonthFilter = document.getElementById('monthFilter').value;
            currentManagerFilter = document.getElementById('managerFilter').value;

            let filtered = allData;
            // ì›”ë³„ í•„í„°
            if (currentMonthFilter !== 'all') {
                filtered = filtered.filter(d => {
                    const date = new Date(d.created_at);
                    const Kdate = new Date(date.getTime() - 9 * 60 * 60 * 1000);
                    const yearMonth = `${Kdate.getFullYear()}-${String(Kdate.getMonth() + 1).padStart(2, '0')}`;
                    return yearMonth === currentMonthFilter;
                });
            }

            // ë‹´ë‹¹ì í•„í„°
            if (currentManagerFilter !== 'all') {
                filtered = filtered.filter(d => getManager(d.id) === currentManagerFilter);
            }

            // ìƒíƒœ í•„í„°
            if (currentStatusFilter !== 'all') {
                filtered = filtered.filter(d => {
                    const status = d.status || 'pending';
                    return status === currentStatusFilter;
                });
            }

            updateStats(filtered);
            renderTable(filtered);
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(data) {
            const total = data.length;
            const pending = data.filter(d => d.status === 'pending' || !d.status).length;
            const paid = data.filter(d => d.status === 'paid').length;
            const fail = data.filter(d => d.status === 'fail').length;

            document.getElementById('totalCount').textContent = total;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('paidCount').textContent = paid;
            document.getElementById('failCount').textContent = fail;
        }

        // í…Œì´ë¸” ë Œë”ë§
        function renderTable(data) {
            const tableBody = document.getElementById('tableBody');

            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="empty">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tableBody.innerHTML = data.map(item => {
                const date = new Date(item.created_at);
                const Kdate = new Date(date.getTime() - 9 * 60 * 60 * 1000);
                const dateStr = Kdate.toLocaleDateString('ko-KR') + ' ' + Kdate.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                const goals = item.goals || [];
                const goalsHtml = goals.map(g => `<span class="goal-tag">${g}</span>`).join('');
                
                const status = item.status || 'pending';
                const manager = getManager(item.id);
                const managerName = getManagerName(item.id);

                return `
                    <tr data-id="${item.id}">
                        <td>${item.id}</td>
                        <td><span class="manager-badge ${manager}">${managerName}</span></td>
                        <td class="date-cell">${dateStr}</td>
                        <td>${item.name}</td>
                        <td>${item.phone}</td>
                        <td class="goals-cell">${goalsHtml}</td>
                        <td>${item.education || '-'}</td>
                        <td>${item.contact_method || '-'}</td>
                        <td>
                            <select class="status-select ${status}" onchange="updateStatus(${item.id}, this.value, this)">
                                <option value="pending" ${status === 'pending' ? 'selected' : ''}>ëŒ€ê¸°ì¤‘</option>
                                <option value="paid" ${status === 'paid' ? 'selected' : ''}>ê²°ì œ</option>
                                <option value="fail" ${status === 'fail' ? 'selected' : ''}>ì‹¤íŒ¨</option>
                            </select>
                        </td>
                        <td>
                            <button class="delete-btn" onclick="deleteConsult(${item.id})">ì‚­ì œ</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        async function updateStatus(id, newStatus, selectElement) {
            try {
                const response = await fetch(`/api/consult/${id}/status`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });

                const result = await response.json();

                if (result.success) {
                    const item = allData.find(d => d.id === id);
                    if (item) item.status = newStatus;
                    
                    selectElement.className = `status-select ${newStatus}`;
                    applyFilters();
                } else {
                    alert('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    loadConsults();
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚­ì œ
        async function deleteConsult(id) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/consult/${id}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    allData = allData.filter(d => d.id !== id);
                    applyFilters();
                } else {
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
    </script>
</body>
</html>